# Deployment Guide

## Render Deployment

This project is configured to deploy on Render.com with the following setup:

### Build Process

1. **Frontend Build**: `npm run build`
   - Builds the React application using Vite
   - Outputs static files to `/dist/` directory
   - Includes `index.html`, assets, and other static files

2. **Backend Build**: `npm run build:backend`
   - Compiles TypeScript backend to JavaScript
   - Outputs compiled files to `/backend/dist/` directory

3. **Production Build**: `npm run build:production`
   - Combines both frontend and backend builds
   - Includes automatic build verification step
   - Used by Render during deployment
   - Ensures `dist/index.html` exists before deployment

### Directory Structure on Render

```
/opt/render/project/src/
├── dist/                    # Frontend build files
│   ├── index.html          # Main HTML file
│   └── assets/             # CSS, JS, images
├── backend/
│   └── dist/               # Backend build files
│       └── index.js        # Main server file
└── ...other project files
```

### Static File Serving

The backend server automatically detects the correct path for static files by trying multiple common locations in this order:

1. `{backend_dir}/../../dist/` - For local development
2. `{working_dir}/dist/` - For Render deployment (primary path)
3. `{working_dir}/../dist/` - For Render when working directory is backend subfolder
4. Explicit Render paths: `/opt/render/project/src/dist`
5. Additional fallback paths for different deployment scenarios

The server includes comprehensive debugging output to help diagnose static file location issues on Render.

### Render Configuration

The `render.yaml` file contains the deployment configuration:

```yaml
services:
  - type: web
    name: makeup-neill
    env: node
    plan: free
    buildCommand: npm install && npm run build:production
    startCommand: node backend/dist/index.js    # ✅ Correct: runs from project root
    healthCheckPath: /api/health
```

#### Important Notes:

- **Working Directory**: The `startCommand` runs from the project root (`/opt/render/project/src/`)
- **Static Files**: Frontend files are built to `dist/` relative to project root
- **Backend Location**: Backend files are in `backend/dist/` relative to project root
- **Do NOT** include directory changes in `startCommand` (e.g., `cd /opt/render/project/src &&`)

#### Common Deployment Issues:

1. **Frontend Files Not Found**
   - **Symptom**: "index.html not found" errors in logs
   - **Cause**: Incorrect working directory in `startCommand`
   - **Solution**: Ensure `startCommand` runs from project root without directory changes

2. **Build Verification Failed**
   - **Symptom**: "Build verification failed: dist/index.html not found"
   - **Cause**: Frontend build process didn't complete successfully
   - **Solution**: Check build logs for Vite compilation errors

### Health Check

The application includes a health check endpoint at `/api/health` which Render uses to verify the service is running correctly.

**Endpoint**: `GET /api/health`
**Response**: `{"status":"OK","message":"Backend server is running"}`

### Environment Variables

Required environment variables for deployment:

- `NODE_ENV=production`
- `PORT=10000` (set by Render)
- `JWT_SECRET` (auto-generated by Render)
- `DATABASE_URL` (must be configured for your PostgreSQL database)

### Troubleshooting Deployment Issues

If you encounter "index.html not found" errors:

1. **Check Build Logs**: Ensure both frontend and backend builds complete successfully
2. **Verify File Structure**: Confirm `dist/index.html` exists after build
3. **Check Server Logs**: The backend logs detailed path resolution information

#### Common Issues and Solutions

**Problem**: "index.html not found at: /opt/render/project/src/dist/index.html"

**Solution**: 
- **Enhanced Path Resolution**: The backend now includes improved path detection for Render's deployment structure
- **Build Verification**: The production build script now includes automatic verification that `dist/index.html` exists
- **Render Environment Detection**: The backend automatically detects Render deployment and adjusts path resolution accordingly
- **Comprehensive Debugging**: Enhanced logging shows exactly which paths are checked and the contents of key directories
- Ensure the build command runs successfully: `npm run build:production`
- The backend will automatically detect and serve files from the correct Render path structure

**Problem**: Static assets (CSS/JS) not loading

**Solution**:
- Verify that the `dist/assets/` directory contains the built files
- Check that the backend serves static files from the correct directory
- Ensure CORS is properly configured for your domain
- Use the enhanced debugging output to verify the static file path resolution

**Problem**: Build fails during deployment

**Solution**:
- The build process now includes automatic verification (`npm run verify:build`)
- Check the build logs for any errors in the frontend or backend compilation
- Ensure all dependencies are properly installed before building

### Manual Deployment Steps

1. Connect your GitHub repository to Render
2. Set the build command: `npm install && npm run build:production`
3. Set the start command: `node backend/dist/index.js`
4. Configure environment variables
5. Deploy

### Local Testing

To test the production build locally:

```bash
# Build both frontend and backend
npm run build:production

# Start the production server
npm start
```

The server will serve static files and handle API routes on the same port.